<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>PSP SIM</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
  header { background-color: #003366; color: white; position: relative; height: 140px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; overflow: hidden; }
  header .title { font-size: 2.8rem; letter-spacing: 1px; text-transform: uppercase; z-index: 2; }
  header .subtitle { font-size: 1.05rem; font-style: italic; margin-top: 8px; text-align: center; max-width: 90%; z-index: 2; }
  header .stripes { position: absolute; bottom: -60px; right: -20px; width: 240px; height: 300px; transform-origin: bottom right; transform: rotate(17deg); pointer-events: none; background: linear-gradient(to right, #003366 0%, #003366 30%, white 30%, white 38%, #003366 38%, #003366 48%, white 48%, white 55%, #003366 55%, #003366 65%, white 65%, white 72%, #003366 72%, #003366 100%); }
  h2 { margin-top: 30px; color: #003366; border-bottom: 2px solid #003366; padding-bottom: 5px; }
  .question { margin-bottom: 20px; padding: 10px; background: white; border-radius: 5px; }
  .options label { display: block; margin-bottom: 5px; }
  #timer { font-size: 20px; font-weight: bold; text-align: center; margin: 20px 0; }
  #submit { display: block; margin: 20px auto; padding: 10px 20px; font-size: 16px; }
  #result { margin-top: 20px; font-size: 18px; font-weight: bold; text-align: center; }
</style>
</head>
<body>

<header>
  <div class="title">PSP SIM</div>
  <div class="subtitle">Simulação da Prova Escrita de Conhecimentos para a Polícia de Segurança Pública </div>
  <div class="stripes"></div>
</header>

<div id="timer" style="font-size: 50px; color: #003366;"> 02:00:00</div> 

<p style="text-align:center;">
  Bem-vindo ao simulador para a <b>Prova Escrita de Conhecimentos da PSP!</b><br>
  <br>
  Este simulador foi criado para uso pessoal, e tem como função simular uma Prova de Conhecimentos o mais fielmente possível. <br>
  O simulador usa dados das Provas Escritas de Conhecimentos disponíveis <a href="http://www.epp.pt/Pages/admissaoprovas.htm" target="_blank" style="color:#003366; text-decoration:underline;">no site da Escola Prática da Polícia</a>. <br>
  Há um temporizador de 120 minutos em contagem decrescente neste simulador. É necessário responder a 80 perguntas, divididas entre os tópicos: <br>
  <br>
  I - Português até ao 12ºano <br>
II - Temas de Cultura Geral <br>
III - Constituição da República Portuguesa (CRP) <br>
IV - Declaração Universal Dos Direitos Humanos (DUDH) <br>
V - Lei Orgânica da Polícia de Segurança Publica <br>
VI - Estatuto Profissional do Pessoal com Funções Policiais da PSP <br>
VII - Instituições da União Europeia <br>
  <br>
As perguntas serão aleatórias. Porém, o formato será o mais fiel a uma Prova de Conhecimentos legítima, utilizando a média de perguntas por tópico. <br>
  Cada pergunta corresponde 0.25 valores. A nota é avaliada de 0 a 20 valores. Notas inferiores a 12 valores darão o resultado "Não Apto" (ver aviso bla bla bla) <br>
  <br>
O PSP SIM foi criado por uma candidata ao Concurso de Formação de Agentes. O PSP SIM não pertence á Polícia de Segurança Pública. O PSP SIM não representa a Polícia de Segurança Pública. O PSP SIM não é monetizado. <br>
  É só material de estudo. <br>
    <br>
Caso encontrem alguma pergunta em que a resposta esteja errada, ou a mesma tenha mudado devido a atualidades, por favor deixem mensagem na minha inbox! <br>
  <br>
    <b>Boa Sorte! :)</b> <br>
  <br>
  O PSP SIM ainda se encontra sobre construção.(140 perguntas adicionadas. Falta limitar a 80, adicionar compreensão de texto e calcular a média)<br>
    
</p>

<form id="quizForm"></form>
<button id="submit">Submeter Teste</button>
<div id="result"></div>

<script>
let testSubmitted = false;
let testQuestions = [];
let time = 2 * 60 * 60; // 2 horas
let timerInterval;
let questionsData = [];

// ===================== CARREGAR JSON =====================
fetch("questions.json")
  .then(response => response.json())
  .then(data => {
    questionsData = data;
    inicializarTudo();
  })
  .catch(err => console.error("Erro ao carregar JSON:", err));

// ===================== FUNÇÕES AUXILIARES =====================
function shuffleArray(arr) {
  for (let i = arr.length -1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ===================== INICIALIZAR =====================
function inicializarTudo() {
  const quizForm = document.getElementById("quizForm");
  const timerDiv = document.getElementById("timer");
  const submitBtn = document.getElementById("submit");
  const resultDiv = document.getElementById("result");

  const topicNames = {
    "I": "Português até ao 12ºano",
    "II": "Temas de Cultura Geral",
    "III": "Constituição da República Portuguesa (CRP)",
    "IV": "Declaração Universal Dos Direitos Humanos (DUDH)",
    "V": "Lei Orgânica da Polícia de Segurança Publica",
    "VI": "Estatuto Profissional do Pessoal com Funções Policiais da PSP",
    "VII": "Instituições da União Europeia"
  };

  // Agrupar perguntas por tópico
  const topics = {};
  questionsData.forEach(q => {
    if (!topics[q.topic]) topics[q.topic] = [];
    topics[q.topic].push(q);
  });

  generateQuiz(topics, topicNames, quizForm);
  startTimer(timerDiv);

  submitBtn.addEventListener("click", e => {
    e.preventDefault();
    if (!testSubmitted) submitTest(resultDiv, quizForm, timerDiv, submitBtn);
    else resetTest(resultDiv, quizForm, timerDiv, submitBtn, topics, topicNames);
  });
}

// ===================== GERAR QUIZ =====================
function generateQuiz(topics, topicNames, quizForm) {
  quizForm.innerHTML = "";
  testQuestions = [];
  let questionCounter = 1;

  Object.keys(topics).forEach(topicKey => {
    const topicQuestions = shuffleArray([...topics[topicKey]]);

    // Título do tópico
    const h2 = document.createElement("h2");
    h2.textContent = `Tópico ${topicKey} - ${topicNames[topicKey]}`;
    quizForm.appendChild(h2);

    topicQuestions.forEach(q => {
      const div = document.createElement("div");
      div.className = "question";
      div.style.marginBottom = "15px";

      const p = document.createElement("p");
      p.innerHTML = `${questionCounter}. ${q.question}`;
      questionCounter++;
      div.appendChild(p);

      let opts = [...q.options];
      let todasOption;
      const todasIndex = opts.findIndex(o => o.startsWith("Todas"));
      if (todasIndex !== -1) todasOption = opts.splice(todasIndex,1)[0];
      opts = shuffleArray(opts);
      if (todasOption) opts.push(todasOption);

      opts.forEach((opt, i) => {
        const label = document.createElement("label");
        label.style.display = "block";
        label.style.marginBottom = "4px";

        const letra = document.createElement("span");
        letra.textContent = `O ${String.fromCharCode(65 + i)}) `;

        const input = document.createElement("input");
        input.type = "radio";
        input.name = `q${q.id}`;
        input.value = i;
        input.style.margin = "0 5px";

        label.appendChild(letra);
        label.appendChild(input);

        const texto = document.createElement("span");
        texto.textContent = opt;
        label.appendChild(texto);

        div.appendChild(label);
      });

      quizForm.appendChild(div);

      testQuestions.push({
        inputName: `q${q.id}`,
        correct: q.correct,
        optionsRendered: opts,
        questionDiv: div
      });
    });
  });
}

// ===================== TIMER =====================
function startTimer(timerDiv) {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const h = String(Math.floor(time/3600)).padStart(2,'0');
    const m = String(Math.floor((time %3600)/60)).padStart(2,'0');
    const s = String(time %60).padStart(2,'0');
    timerDiv.textContent = `${h}:${m}:${s}`;
    if(time<=0){
      clearInterval(timerInterval);
      document.getElementById("submit").click();
    }
    time--;
  }, 1000);
}

// ===================== SUBMETER =====================
function submitTest(resultDiv, quizForm, timerDiv, submitBtn){
  clearInterval(timerInterval);
  let scoreCount = 0;

  testQuestions.forEach(q => {
    q.questionDiv.querySelectorAll(".feedback").forEach(f=>f.remove());
    q.questionDiv.style.border = "2px solid #ccc";

    const feedback = document.createElement("div");
    feedback.className = "feedback";
    feedback.style.marginTop = "8px";
    feedback.style.fontWeight = "bold";

    const selected = document.querySelector(`input[name="${q.inputName}"]:checked`);

    if(selected){
      const userIndex = parseInt(selected.value);
      const userAnswerText = q.optionsRendered[userIndex];

      if(userAnswerText === q.correct){
        scoreCount++;
        q.questionDiv.style.border = "2px solid green";
        feedback.style.color = "green";
        feedback.textContent = "✔ Resposta correta";
      } else {
        q.questionDiv.style.border = "2px solid red";
        feedback.style.color = "red";
        feedback.innerHTML = `✘ Resposta errada<br>
        A tua resposta: O ${String.fromCharCode(65+userIndex)}) ${userAnswerText}<br>
        Resposta correta: ${q.correct}`;
      }
    } else {
      q.questionDiv.style.border = "2px solid orange";
      feedback.style.color = "orange";
      feedback.innerHTML = `⚠ Pergunta não respondida<br>Resposta correta: ${q.correct}`;
    }

    q.questionDiv.appendChild(feedback);

    q.questionDiv.querySelectorAll("input[type=radio]").forEach(radio=>radio.disabled=true);
  });

  const finalScore = (scoreCount / testQuestions.length)*20;
  resultDiv.innerHTML = `Acertaste ${scoreCount}/${testQuestions.length} perguntas.<br>
    Nota final: <span style="font-size:2em"><strong>${finalScore.toFixed(2)}/20</strong></span>`;

  const aptoDiv = document.createElement("div");
  aptoDiv.id = "aptoDiv";
  aptoDiv.style.textAlign = "center";
  aptoDiv.style.marginTop = "10px";
  aptoDiv.style.fontSize = "60px";
  aptoDiv.style.color = finalScore>=12 ? "green":"red";
  aptoDiv.textContent = finalScore>=12 ? "APTO":"NÃO APTO";
  resultDiv.appendChild(aptoDiv);

  testSubmitted = true;
  submitBtn.textContent = "Novo Teste";
}

// ===================== RESET =====================
function resetTest(resultDiv, quizForm, timerDiv, submitBtn, topics, topicNames){
  resultDiv.textContent = "";
  generateQuiz(topics, topicNames, quizForm);
  time = 2*60*60;
  startTimer(timerDiv);
  testSubmitted = false;
  submitBtn.textContent = "Submeter Teste";
}
</script>
</body>
</html>