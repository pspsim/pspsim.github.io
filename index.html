<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>PSP SIM</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
  header { background-color: #003366; color: white; position: relative; height: 140px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; overflow: hidden; }
  header .title { font-size: 2.8rem; letter-spacing: 1px; text-transform: uppercase; z-index: 2; }
  header .subtitle { font-size: 1.05rem; font-style: italic; margin-top: 8px; text-align: center; max-width: 90%; z-index: 2; }
  header .stripes { position: absolute; bottom: -60px; right: -20px; width: 240px; height: 300px; transform-origin: bottom right; transform: rotate(17deg); pointer-events: none; background: linear-gradient(to right, #003366 0%, #003366 30%, white 30%, white 38%, #003366 38%, #003366 48%, white 48%, white 55%, #003366 55%, #003366 65%, white 65%, white 72%, #003366 72%, #003366 100%); }
  h2 { margin-top: 30px; color: #003366; border-bottom: 2px solid #003366; padding-bottom: 5px; }
  .question { margin-bottom: 20px; padding: 10px; background: white; border-radius: 5px; }
  .options label { display: block; margin-bottom: 5px; }
  #timer { font-size: 20px; font-weight: bold; text-align: center; margin: 20px 0; }
  #submit { display: block; margin: 20px auto; padding: 10px 20px; font-size: 16px; }
  #result { margin-top: 20px; font-size: 18px; font-weight: bold; text-align: center; }
</style>
</head>
<body>

<header>
  <div class="title">PSP SIM</div>
  <div class="subtitle">Simula√ß√£o da Prova Escrita de Conhecimentos para a Pol√≠cia de Seguran√ßa P√∫blica </div>
  <div class="stripes"></div>
</header>

<div id="timer" style="font-size: 50px; color: #003366;"> 02:00:00</div> 

<p style="text-align:center;">
  Bem-vindo ao simulador para a <b>Prova Escrita de Conhecimentos da PSP!</b><br>
  <br>
  Este simulador foi criado para uso pessoal, e tem como fun√ß√£o simular uma Prova de Conhecimentos o mais fielmente poss√≠vel. <br>
  O simulador usa dados das Provas Escritas de Conhecimentos dispon√≠veis <a href="http://www.epp.pt/Pages/admissaoprovas.htm" target="_blank" style="color:#003366; text-decoration:underline;">no site da Escola Pr√°tica da Pol√≠cia</a>. <br>
  H√° um temporizador de 120 minutos em contagem decrescente neste simulador. √â necess√°rio responder a 80 perguntas, divididas entre os t√≥picos: <br>
  <br>
  I - Portugu√™s at√© ao 12¬∫ano <br>
II - Temas de Cultura Geral <br>
III - Constitui√ß√£o da Rep√∫blica Portuguesa (CRP) <br>
IV - Declara√ß√£o Universal Dos Direitos Humanos (DUDH) <br>
V - Lei Org√¢nica da Pol√≠cia de Seguran√ßa Publica <br>
VI - Estatuto Profissional do Pessoal com Fun√ß√µes Policiais da PSP <br>
VII - Institui√ß√µes da Uni√£o Europeia <br>
  <br>
As perguntas ser√£o aleat√≥rias. Por√©m, o formato ser√° o mais fiel a uma Prova de Conhecimentos leg√≠tima, utilizando a m√©dia de perguntas por t√≥pico. <br>
  Cada pergunta corresponde 0.25 valores. A nota √© avaliada de 0 a 20 valores. Notas inferiores a 12 valores dar√£o o resultado "N√£o Apto" (ver aviso bla bla bla) <br>
  <br>
O PSP SIM foi criado por uma candidata ao Concurso de Forma√ß√£o de Agentes. O PSP SIM n√£o pertence √° Pol√≠cia de Seguran√ßa P√∫blica. O PSP SIM n√£o representa a Pol√≠cia de Seguran√ßa P√∫blica. O PSP SIM n√£o √© monetizado. <br>
  √â s√≥ material de estudo. <br>
    <br>
Caso encontrem alguma pergunta em que a resposta esteja errada, ou a mesma tenha mudado devido a atualidades, por favor deixem mensagem na minha inbox! <br>
  <br>
    <b>Boa Sorte! :)</b> <br>
  <br>
  O PSP SIM ainda se encontra sobre constru√ß√£o.<br>
    
</p>

<form id="quizForm"></form>
<button id="submit">Submeter Teste</button>
<div id="result"></div>

<script>
let testSubmitted = false;
let testQuestions = [];
let questionsData = [];
let topics = {}; // üîπ √öNICO topics GLOBAL (importante)

// ===================== CARREGAR JSON =====================
fetch("questions.json")
  .then(response => response.json())
  .then(data => {
    questionsData = data;
    inicializarTudo(); // s√≥ arranca quando o JSON j√° chegou
  });

// ===================== ELEMENTOS =====================
const quizForm = document.getElementById("quizForm");
const timerDiv = document.getElementById("timer");
const submitBtn = document.getElementById("submit");
const resultDiv = document.getElementById("result");

const topicNames = {
  "I": "Portugu√™s at√© ao 12¬∫ano",
  "II": "Temas de Cultura Geral",
  "III": "Constitui√ß√£o da Rep√∫blica Portuguesa (CRP)",
  "IV": "Declara√ß√£o Universal Dos Direitos Humanos (DUDH)",
  "V": "Lei Org√¢nica da Pol√≠cia de Seguran√ßa Publica",
  "VI": "Estatuto Profissional do Pessoal com Fun√ß√µes Policiais da PSP",
  "VII": "Institui√ß√µes da Uni√£o Europeia"
};

// ===================== FUN√á√ÉO PARA EMBARALHAR ARRAY =====================
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ===================== GERAR QUIZ =====================
function generateQuiz() {
  quizForm.innerHTML = "";
  testQuestions = [];
  let questionCounter = 1;

  Object.keys(topics).forEach(topicKey => {
    const topicQuestions = shuffleArray([...topics[topicKey]]);

    const h2 = document.createElement("h2");
    h2.textContent = `T√≥pico ${topicKey} - ${topicNames[topicKey]}`;
    quizForm.appendChild(h2);

    topicQuestions.forEach(q => {
      const div = document.createElement("div");
      div.className = "question";
      div.style.marginBottom = "15px";

      const p = document.createElement("p");
      p.innerHTML = `${questionCounter}. ${q.question}`;
      questionCounter++;
      div.appendChild(p);

      // Embaralhar op√ß√µes mantendo "Todas..." no fim
      let opts = [...q.options];
      let todasOption;
      const todasIndex = opts.findIndex(o => o.startsWith("Todas"));
      if (todasIndex !== -1) {
        todasOption = opts.splice(todasIndex, 1)[0];
      }
      opts = shuffleArray(opts);
      if (todasOption) opts.push(todasOption);

      opts.forEach((opt, i) => {
        const label = document.createElement("label");
        label.style.display = "block";
        label.style.marginBottom = "4px";

        const letra = document.createElement("span");
        letra.textContent = `O ${String.fromCharCode(65 + i)}) `;

        const input = document.createElement("input");
        input.type = "radio";
        input.name = `q${q.id}`;
        input.value = i;
        input.style.marginLeft = "5px";
        input.style.marginRight = "5px";

        label.appendChild(letra);
        label.appendChild(input);

        const texto = document.createElement("span");
        texto.textContent = opt;
        label.appendChild(texto);

        div.appendChild(label);
      });

      quizForm.appendChild(div);

      testQuestions.push({
        inputName: `q${q.id}`,
        correct: q.correct,
        optionsRendered: opts,
        questionDiv: div
      });
    });
  });
}

// ===================== TIMER =====================
let time = 2 * 60 * 60; // 2 horas
let timerInterval;

function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const h = String(Math.floor(time / 3600)).padStart(2, '0');
    const m = String(Math.floor((time % 3600) / 60)).padStart(2, '0');
    const s = String(time % 60).padStart(2, '0');
    timerDiv.textContent = `${h}:${m}:${s}`;

    if (time <= 0) {
      clearInterval(timerInterval);
      submitTest();
    }
    time--;
  }, 1000);
}

// ===================== SUBMETER TESTE =====================
function submitTest() {
  clearInterval(timerInterval);
  let scoreCount = 0;

  testQuestions.forEach(q => {
    q.questionDiv.querySelectorAll('.feedback').forEach(f => f.remove());
    q.questionDiv.style.border = "2px solid #ccc";

    const feedback = document.createElement("div");
    feedback.className = "feedback";
    feedback.style.marginTop = "8px";
    feedback.style.fontWeight = "bold";

    const selected = document.querySelector(`input[name="${q.inputName}"]:checked`);

    if (selected) {
      const userIndex = parseInt(selected.value);
      const userAnswerText = q.optionsRendered[userIndex];

      if (userAnswerText === q.correct) {
        scoreCount++;
        q.questionDiv.style.border = "2px solid green";
        feedback.style.color = "green";
        feedback.textContent = "‚úî Resposta correta";
      } else {
        q.questionDiv.style.border = "2px solid red";
        feedback.style.color = "red";
        feedback.innerHTML = `
          ‚úò Resposta errada<br>
          A tua resposta: O ${String.fromCharCode(65 + userIndex)}) ${userAnswerText}<br>
          Resposta correta: ${q.correct}
        `;
      }
    } else {
      q.questionDiv.style.border = "2px solid orange";
      feedback.style.color = "orange";
      feedback.innerHTML = `
          ‚ö† Pergunta n√£o respondida<br>
          Resposta correta: ${q.correct}
        `;
    }

    q.questionDiv.appendChild(feedback);

    q.questionDiv.querySelectorAll("input[type=radio]").forEach(radio => {
      radio.disabled = true;
    });
  });

  const finalScore = (scoreCount / testQuestions.length) * 20;

  resultDiv.innerHTML = `
    Acertaste ${scoreCount}/${testQuestions.length} perguntas.<br>
    Nota final: <br>
    <span style="font-size:2em"><strong>${finalScore.toFixed(2)}/20</strong></span>
  `;

  const aptoDiv = document.createElement("div");
  aptoDiv.style.textAlign = "center";
  aptoDiv.style.marginTop = "10px";
  aptoDiv.style.fontSize = "60px";
  aptoDiv.style.color = finalScore >= 10 ? "green" : "red";
  aptoDiv.textContent = finalScore >= 10 ? "APTO" : "N√ÉO APTO";

  const oldApto = document.getElementById("aptoDiv");
  if (oldApto) oldApto.remove();

  aptoDiv.id = "aptoDiv";
  resultDiv.appendChild(aptoDiv);

  testSubmitted = true;
  submitBtn.textContent = "Novo Teste";
}

// ===================== INICIALIZAR TUDO (S√ì DEPOIS DO JSON) =====================
function inicializarTudo() {
  topics = {}; // limpa e recria

  questionsData.forEach(q => {
    if (!topics[q.topic]) topics[q.topic] = [];
    topics[q.topic].push(q);
  });

  generateQuiz();
  startTimer();
}

// ===================== EVENTO BOT√ÉO =====================
submitBtn.addEventListener("click", e => {
  e.preventDefault();

  if (!testSubmitted) {
    submitTest();
  } else {
    generateQuiz();
    time = 2 * 60 * 60;
    startTimer();
    testSubmitted = false;
    submitBtn.textContent = "Submeter Teste";
    resultDiv.textContent = "";
  }
});
</script>
</body>
</html>